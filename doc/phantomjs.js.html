<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: drivers/phantomjs.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: drivers/phantomjs.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/** @module drivers/phantomjs */

'use strict';

var MOCHA_PHANTOMJS_PATH = '/mocha-phantomjs/lib/mocha-phantomjs.coffee';

var path        = require('path'),
    url         = require('url'),
    spawn       = require('child_process').spawn,
    util        = require('../util'),
    Logger      = require('../logger'),
    JetRunner   = require('../'),
    Client      = require('./client');

function PhantomJsClient(tests, config) {
    this.initialize(tests, config);
}

PhantomJsClient.prototype = util.merge(new Client, {

    name: 'PhantomJS',

    queue: [],

    /**
     * @overridden
     *
     * TODO: Find out how to use the same PhantomJS instance for all test suites! (https://github.com/metaskills/mocha-phantomjs/tree/v2.0.1)
     */
    run: function() {
        var self = this, tests = this.tests;

        function runInstanceWith(url) {
            return function() {
                self.runInstance(url);
            };
        }

        for(var test in tests) {
            this.addRunner(runInstanceWith(this.getTestURL(test)));
        }

        if(this.queue.length) this.runNext();
        else this.emit('complete', this.TestStatusEnum.PASS);
    },

    /**
     * @param test
     */
    runInstance: function(test) {
        var IndicatorsEnum  = Client.IndicatorsEnum,
            TestStatusEnum  = Client.TestStatusEnum,
            self            = this,
            queue           = this.queue,
            runNext         = this.runNext.bind(this),
            client          = this.config.client,
            name            = this.name,
            suite           = Client.getTestPathFromURL(test),
            phantom         = spawn('phantomjs', [path.resolve(__dirname + MOCHA_PHANTOMJS_PATH), test, client.reporter], { stdio: 'inherit' }),
            pid;

        function done(code) {
            if(queue.length && (code == TestStatusEnum.PASS || client.continueOnFail)) runNext();
            else {
                self.emit(!code ? 'success' : 'failure', code || undefined);
                self.emit('complete', code);
            }
        }

        Logger.log('JetRunner client (' + name + ') - started' + (pid = ' (PID:' + phantom.pid + ')'));
        Logger.log('JetRunner client (' + name + ') - testing "' + suite + '"...');
        Logger.log('JetRunner URL: '.grey + decodeURIComponent(test).cyan);

        phantom.on('exit', function(code) {
            Logger.log('JetRunner client (' + name + ') - finished "' + suite +'": ' + (code && IndicatorsEnum.FAILURE || IndicatorsEnum.SUCCESS));
            Logger.log('JetRunner client (' + name + ') - shut down' + pid);
            done(code);
        });
    },

    /**
     * @param {Function} runner
     * @returns {*}
     */
    addRunner: function(runner) {
        this.queue.push(runner);
        return this;
    },

    runNext: function() {
        this.queue.length && this.queue.shift()();
        return this;
    }

});

module.exports = PhantomJsClient;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-cli.html">cli</a></li><li><a href="module-config.html">config</a></li><li><a href="browserstack.html">drivers/browserstack</a></li><li><a href="client.html">drivers/client</a></li><li><a href="phantomjs.html">drivers/phantomjs</a></li><li><a href="saucelabs.html">drivers/saucelabs</a></li><li><a href="tunnel_client.html">drivers/tunnel_client</a></li><li><a href="module-index.html">index</a></li><li><a href="module-logger.html">logger</a></li><li><a href="module-run.html">run</a></li><li><a href="module-server.html">server</a></li><li><a href="module-util.html">util</a></li></ul><h3>Classes</h3><ul><li><a href="saucelabs-SauceLabsClient.html">SauceLabsClient</a></li><li><a href="tunnel_client-TunnelClient.html">TunnelClient</a></li><li><a href="module-server-Server.html">Server</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a> on Tue Apr 16 2013 13:36:11 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
</body>
</html>
