!!! 5
html(lang="en")
  head
    title= title
    each style in styles
      link(href="#{style}", rel="stylesheet")
  body
    div
      strong JetRunner URL:
      pre(style="white-space:normal;border:solid 1px #ccc;background:#ebebeb;padding:20px;")
        script
          document.write(decodeURIComponent(location));
    div#jetrunner-stream-debug
    script
      if(#{DEBUG}) {
        this.onerror = function(err, url, line) {
          document.getElementById('jetrunner-stream-debug').innerHTML += '<p>' + [err, '[' + decodeURIComponent(url) + ':' + line + ']'].join(' ') + '</p>';
        }
      }
    div#mocha
    each script in scripts
      script(src="#{script}")
    script
      //this.assert = this.chai.assert;
      //this.expect = this.chai.expect;
      this.mocha.ignoreLeaks();
      this.mocha.ui();
    if src
        script(src="#{src}")
    script(src="#{test}")
    script
      this.reporter = (this.mochaPhantomJS || this.mocha).run(function() {
        var cache = [];

        if (!Array.prototype.indexOf) {
            Array.prototype.indexOf = function(obj, start) {
                 for (var i = (start || 0), j = this.length; i < j; i++) {
                     if (this[i] === obj) { return i; }
                 }
                 return -1;
            }
        }

        try {
            self.jetstream = JSON.stringify(self.reporter, function(key, value) {
                if (typeof value === 'object' && value !== null) {
                    if (cache.indexOf(value) !== -1) {
                        // Circular reference found, discard key
                        return;
                    }
                    // Store value in our collection
                    cache.push(value);
                }
                return value;
            });
        } catch(e) {
            self.jetstream = null;
        } finally {
            cache = null;
        }
      });